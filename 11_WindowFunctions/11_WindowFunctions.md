# T-SQL Window Functions ‚Äì √úbersicht  

## 1 | Begriffsdefinition

| SQL-Term | Beschreibung |
|---|---|
| `OVER()` | Rahmenklausel f√ºr Fensterfunktionen; definiert **Partition** (`PARTITION BY`), **Reihenfolge** (`ORDER BY`) und optional den **Frame** (`ROWS`/`RANGE`). |
| Partition | Logische Unterteilung der Eingabemenge; Fensterfunktionen werden je Partition berechnet. |
| Fensterreihenfolge | `ORDER BY` innerhalb von `OVER()`; bestimmt Rangfolge und ‚Äûvorher/nachher‚Äú f√ºr `LAG/LEAD`. |
| Frame (`ROWS`/`RANGE`) | Bereich relativ zur aktuellen Zeile (z. B. laufende Summen). In T-SQL ist `RANGE` eingeschr√§nkt; f√ºr gleitende Fenster i. d. R. `ROWS` verwenden. |
| `ROW_NUMBER()` | Fortlaufende Zeilennummer **ohne** L√ºcken innerhalb einer Partition; ben√∂tigt `ORDER BY`. |
| `RANK()` / `DENSE_RANK()` | Rang mit/ohne L√ºcken bei Gleichst√§nden (‚ÄûTies‚Äú). |
| `NTILE(n)` | Teilt geordnete Partition in `n` m√∂glichst gleich gro√üe **Buckets**. |
| `LAG(expr, off, def)` | Wert **vorheriger** Zeile relativ zur aktuellen; `off`/`def` optional. |
| `LEAD(expr, off, def)` | Wert **folgender** Zeile relativ zur aktuellen. |
| `FIRST_VALUE()` / `LAST_VALUE()` | Ersten/letzten Wert im **Frame** (nicht zwingend ganze Partition!) ‚Äì Frame korrekt setzen. |
| Window-Aggregate | Aggregatfunktionen in `OVER()` (z. B. `SUM() OVER(...)`) ‚Äì **verdichten nicht**, Zeilen bleiben erhalten. |
| Determinismus | Eindeutige Reihenfolge durch zus√§tzliche Sortschl√ºssel (Tiebreaker) sicherstellen, sonst k√∂nnen Ergebnisse schwanken. |
| NULL-Ordnung | SQL Server kennt kein `NULLS FIRST/LAST`; `NULL` sortiert standardm√§√üig wie ‚Äûsehr klein‚Äú bei `ASC`. |
| Performance | Sort/Spool/Memory Grants m√∂glich; Partitionierung & Indexe auf Sortierschl√ºssel helfen. |

---

## 2 | Struktur

### 2.1 | `OVER()`-Grundlagen: PARTITION, ORDER, Frame
> **Kurzbeschreibung:** Syntax & Bausteine von `OVER()`, Unterschiede zu `GROUP BY`, logische Auswertung.

- üìì **Notebook:**  
  [`08_01_over_grundlagen.ipynb`](08_01_over_grundlagen.ipynb)

- üé• **YouTube:**  
  - [OVER Clause ‚Äì Basics](https://www.youtube.com/results?search_query=sql+server+over+clause+basics)

- üìò **Docs:**  
  - [`OVER`-Klausel](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql)

---

### 2.2 | Ranking: `ROW_NUMBER()` vs. `RANK()` vs. `DENSE_RANK()` (+ `NTILE`)
> **Kurzbeschreibung:** Gleichst√§nde, L√ºcken, Ties; geeignete Anwendungsf√§lle und Tiebreaker.

- üìì **Notebook:**  
  [`08_02_ranking_row_number_rank_dense_rank_ntile.ipynb`](08_02_ranking_row_number_rank_dense_rank_ntile.ipynb)

- üé• **YouTube:**  
  - [ROW_NUMBER vs RANK vs DENSE_RANK](https://www.youtube.com/results?search_query=sql+server+row_number+rank+dense_rank)

- üìò **Docs:**  
  - [Ranking Functions (`ROW_NUMBER`, `RANK`, `DENSE_RANK`, `NTILE`)](https://learn.microsoft.com/en-us/sql/t-sql/functions/ranking-functions-transact-sql)

---

### 2.3 | Offsets: `LAG()` & `LEAD()` in der Praxis
> **Kurzbeschreibung:** Vorher/Nachher-Vergleiche, Delta-Berechnungen, Standardwerte am Rand der Partition.

- üìì **Notebook:**  
  [`08_03_lag_lead_patterns.ipynb`](08_03_lag_lead_patterns.ipynb)

- üé• **YouTube:**  
  - [Using LAG/LEAD](https://www.youtube.com/results?search_query=sql+server+lag+lead)

- üìò **Docs:**  
  - [`LAG`](https://learn.microsoft.com/en-us/sql/t-sql/functions/lag-transact-sql) ¬∑ [`LEAD`](https://learn.microsoft.com/en-us/sql/t-sql/functions/lead-transact-sql)

---

### 2.4 | Laufende Summen & gleitende Fenster
> **Kurzbeschreibung:** `SUM() OVER(ORDER BY ‚Ä¶ ROWS BETWEEN ‚Ä¶)` f√ºr Running Totals, Moving Averages, Window Count.

- üìì **Notebook:**  
  [`08_04_running_totals_moving_avg.ipynb`](08_04_running_totals_moving_avg.ipynb)

- üé• **YouTube:**  
  - [Running Totals with WINDOW](https://www.youtube.com/results?search_query=sql+server+running+total+window+functions)

- üìò **Docs:**  
  - [`OVER` ‚Äì Frames mit `ROWS`/`RANGE`](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql#arguments)

---

### 2.5 | Frames verstehen: `ROWS` vs. `RANGE`
> **Kurzbeschreibung:** Korrekte Frames definieren, Limitierungen von `RANGE` in T-SQL, Ties & numerische/orderbare Typen.

- üìì **Notebook:**  
  [`08_05_rows_vs_range_frames.ipynb`](08_05_rows_vs_range_frames.ipynb)

- üé• **YouTube:**  
  - [ROWS vs RANGE explained](https://www.youtube.com/results?search_query=sql+server+rows+vs+range)

- üìò **Docs:**  
  - [`OVER` ‚Äì Frame-Klausel](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql#rows-and-range)

---

### 2.6 | Top-N pro Gruppe: `ROW_NUMBER()` filtern
> **Kurzbeschreibung:** ‚ÄûBeste‚Äú Zeile je Partition ermitteln (Top-1/Top-N), typische CTE-Muster.

- üìì **Notebook:**  
  [`08_06_top_n_per_group_row_number.ipynb`](08_06_top_n_per_group_row_number.ipynb)

- üé• **YouTube:**  
  - [Top N per Group with ROW_NUMBER](https://www.youtube.com/results?search_query=sql+server+top+n+per+group+row_number)

- üìò **Docs:**  
  - [`ROW_NUMBER`](https://learn.microsoft.com/en-us/sql/t-sql/functions/row-number-transact-sql)

---

### 2.7 | Pagination: `ROW_NUMBER()` vs. `OFFSET/FETCH`
> **Kurzbeschreibung:** Stabil paginieren mit eindeutigem `ORDER BY`; Vor-/Nachteile beider Ans√§tze.

- üìì **Notebook:**  
  [`08_07_pagination_row_number_offset_fetch.ipynb`](08_07_pagination_row_number_offset_fetch.ipynb)

- üé• **YouTube:**  
  - [Paging Strategies in T-SQL](https://www.youtube.com/results?search_query=sql+server+pagination+row_number+offset+fetch)

- üìò **Docs:**  
  - [`ORDER BY ‚Ä¶ OFFSET/FETCH`](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-order-by-clause-transact-sql)

---

### 2.8 | Gaps & Islands mit `LAG()`
> **Kurzbeschreibung:** Folgen/Gruppen erkennen (Sessions, zusammenh√§ngende Bereiche), Start/Ende je Insel bestimmen.

- üìì **Notebook:**  
  [`08_08_gaps_and_islands_with_lag.ipynb`](08_08_gaps_and_islands_with_lag.ipynb)

- üé• **YouTube:**  
  - [Gaps & Islands (Window Functions)](https://www.youtube.com/results?search_query=sql+server+gaps+and+islands+lag)

- üìò **Docs/Blog:**  
  - [`LAG`](https://learn.microsoft.com/en-us/sql/t-sql/functions/lag-transact-sql)

---

### 2.9 | Deduplizieren: Duplikate per `ROW_NUMBER()` entfernen
> **Kurzbeschreibung:** Dubs markieren (`ROW_NUMBER()` √ºber Schl√ºssel, ORDER BY Pr√§ferenz) und mit `DELETE`/`QUALIFY`-√Ñquivalent l√∂schen.

- üìì **Notebook:**  
  [`08_09_dedupe_with_row_number.ipynb`](08_09_dedupe_with_row_number.ipynb)

- üé• **YouTube:**  
  - [Remove Duplicates with ROW_NUMBER](https://www.youtube.com/results?search_query=sql+server+remove+duplicates+row_number)

- üìò **Docs:**  
  - [`ROW_NUMBER`](https://learn.microsoft.com/en-us/sql/t-sql/functions/row-number-transact-sql)

---

### 2.10 | `FIRST_VALUE`/`LAST_VALUE` ‚Äì Frame-Fallstricke
> **Kurzbeschreibung:** Warum `LAST_VALUE()` oft den **aktuellen** Wert liefert; richtigen Frame setzen (`ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING`).

- üìì **Notebook:**  
  [`08_10_first_last_value_frames.ipynb`](08_10_first_last_value_frames.ipynb)

- üé• **YouTube:**  
  - [FIRST/LAST VALUE Gotchas](https://www.youtube.com/results?search_query=sql+server+first_value+last_value+frame)

- üìò **Docs:**  
  - [`FIRST_VALUE`](https://learn.microsoft.com/en-us/sql/t-sql/functions/first-value-transact-sql) ¬∑ [`LAST_VALUE`](https://learn.microsoft.com/en-us/sql/t-sql/functions/last-value-transact-sql)

---

### 2.11 | Prozent-Rang & kumulative Verteilung
> **Kurzbeschreibung:** `PERCENT_RANK()`/`CUME_DIST()` f√ºr Perzentile, Rankings in Analysen.

- üìì **Notebook:**  
  [`08_11_percent_rank_cume_dist.ipynb`](08_11_percent_rank_cume_dist.ipynb)

- üé• **YouTube:**  
  - [Percent Rank & Cume Dist](https://www.youtube.com/results?search_query=sql+server+percent_rank+cume_dist)

- üìò **Docs:**  
  - [`PERCENT_RANK`](https://learn.microsoft.com/en-us/sql/t-sql/functions/percent-rank-transact-sql) ¬∑ [`CUME_DIST`](https://learn.microsoft.com/en-us/sql/t-sql/functions/cume-dist-transact-sql)

---

### 2.12 | Null-Handling & Ties: deterministische Ergebnisse
> **Kurzbeschreibung:** NULL-Verhalten, stabile Sortierung mit zus√§tzlichen Keys, Kollationsaspekte bei Text.

- üìì **Notebook:**  
  [`08_12_nulls_ties_determinism.ipynb`](08_12_nulls_ties_determinism.ipynb)

- üé• **YouTube:**  
  - [Deterministic Window Results](https://www.youtube.com/results?search_query=sql+server+deterministic+order+by+ties)

- üìò **Docs:**  
  - [Data Type/Collation Precedence](https://learn.microsoft.com/en-us/sql/t-sql/data-types/data-type-precedence-transact-sql)

---

### 2.13 | Performance: Indizes, Sorts, Memory Grants
> **Kurzbeschreibung:** Wie Indizes auf (`PARTITION BY`+`ORDER BY`) helfen; Parallelit√§t, Spools, Batch Mode on Rowstore (2019+).

- üìì **Notebook:**  
  [`08_13_performance_window_functions.ipynb`](08_13_performance_window_functions.ipynb)

- üé• **YouTube:**  
  - [T-SQL Window Functions ‚Äì Performance](https://www.youtube.com/results?search_query=sql+server+window+functions+performance)

- üìò **Docs:**  
  - [Query Processing Architecture](https://learn.microsoft.com/en-us/sql/relational-databases/query-processing-architecture-guide)

---

### 2.14 | Columnstore & gro√üe Partitionen
> **Kurzbeschreibung:** Batch Mode, Segment-Elimination, Einfluss auf Ranking/Offsets.

- üìì **Notebook:**  
  [`08_14_columnstore_windowing.ipynb`](08_14_columnstore_windowing.ipynb)

- üé• **YouTube:**  
  - [Windowing on Columnstore](https://www.youtube.com/results?search_query=sql+server+columnstore+window+functions)

- üìò **Docs:**  
  - [Columnstore ‚Äì Query Performance](https://learn.microsoft.com/en-us/sql/relational-databases/indexes/columnstore-indexes-query-performance)

---

### 2.15 | Qualit√§t & Tests
> **Kurzbeschreibung:** Erwartete Rangfolgen pr√ºfen, Gleichstands-Szenarien testen, Regressionen via kontrollierter Datenstubs.

- üìì **Notebook:**  
  [`08_15_quality_testing_window.ipynb`](08_15_quality_testing_window.ipynb)

- üé• **YouTube:**  
  - [Testing Window Queries](https://www.youtube.com/results?search_query=sql+server+test+window+functions)

- üìò **Docs:**  
  - [DMVs/Execution Plans ‚Äì √úberblick](https://learn.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/system-dynamic-management-views)

---

### 2.16 | Anti-Patterns & Fallstricke
> **Kurzbeschreibung:** Fehlende/instabile `ORDER BY`-Keys, falsche Frames bei `LAST_VALUE`, Funktionen in Sortschl√ºsseln, gigantische Partitionen ohne Vorfilter.

- üìì **Notebook:**  
  [`08_16_window_anti_patterns.ipynb`](08_16_window_anti_patterns.ipynb)

- üé• **YouTube:**  
  - [Common Window Function Mistakes](https://www.youtube.com/results?search_query=sql+server+window+functions+mistakes)

- üìò **Docs/Blog:**  
  - [`OVER` ‚Äì Hinweise & Einschr√§nkungen](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql#remarks)  
  - [SARGability & Expressions](https://www.brentozar.com/archive/2018/02/sargable-queries/)

---

## 3 | Weiterf√ºhrende Informationen

- üìò Microsoft Learn: [`OVER`-Klausel ‚Äì Referenz](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql)  
- üìò Microsoft Learn: [Ranking Functions (`ROW_NUMBER`/`RANK`/`DENSE_RANK`/`NTILE`)](https://learn.microsoft.com/en-us/sql/t-sql/functions/ranking-functions-transact-sql)  
- üìò Microsoft Learn: [`LAG` & `LEAD`](https://learn.microsoft.com/en-us/sql/t-sql/functions/lag-transact-sql) ¬∑ (Lead) [(link)](https://learn.microsoft.com/en-us/sql/t-sql/functions/lead-transact-sql)  
- üìò Microsoft Learn: [`FIRST_VALUE` / `LAST_VALUE`](https://learn.microsoft.com/en-us/sql/t-sql/functions/first-value-transact-sql)  
- üìò Microsoft Learn: [Windowed Aggregates ‚Äì Beispiele](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql#examples)  
- üìò Microsoft Learn: [`ORDER BY` & Pagination (`OFFSET/FETCH`)](https://learn.microsoft.com/en-us/sql/t-sql/queries/select-order-by-clause-transact-sql)  
- üìò Microsoft Learn: [Data Type / Collation Precedence](https://learn.microsoft.com/en-us/sql/t-sql/data-types/data-type-precedence-transact-sql)  
- üìò Microsoft Learn: [Query Processing Architecture Guide](https://learn.microsoft.com/en-us/sql/relational-databases/query-processing-architecture-guide)  
- üìò Microsoft Learn: [Columnstore ‚Äì Performance](https://learn.microsoft.com/en-us/sql/relational-databases/indexes/columnstore-indexes-query-performance)  
- üìù SQLPerformance: *Window Functions ‚Äì Planformen & Tuning* (Suche) ‚Äì https://www.sqlperformance.com/?s=window+functions  
- üìù Itzik Ben-Gan: *Windowing Patterns & Best Practices* ‚Äì https://tsql.solidq.com/  
- üìù Erik Darling: *Frames, Ties & Performance-Hinweise* ‚Äì https://www.erikdarlingdata.com/  
- üìù Simple Talk (Redgate): *Practical Window Functions* ‚Äì https://www.red-gate.com/simple-talk/?s=window+functions  
- üé• YouTube Playlist: *T-SQL Window Functions* (Sammlung) ‚Äì https://www.youtube.com/results?search_query=itzik+ben+gan+window+functions  
