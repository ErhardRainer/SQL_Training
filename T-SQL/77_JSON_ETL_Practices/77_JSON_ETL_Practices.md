# T-SQL JSON f√ºr ETL ‚Äì √úbersicht  
*Verarbeitung von JSON-Daten, Validierung, Fehlertoleranz, Performance*

## 1 | Begriffsdefinition

| SQL-Term | Beschreibung |
|---|---|
| JSON in SQL Server | **Kein** eigener `JSON`-Datentyp ‚Äì JSON wird in `NVARCHAR` (meist `NVARCHAR(MAX)`) gespeichert/verarbeitet. |
| `ISJSON` | Pr√ºft, ob ein Ausdruck g√ºltiges JSON ist (`CHECK (ISJSON(JsonCol)=1)`); n√ºtzlich f√ºr **Constraints**/Filter. |
| `JSON_VALUE` | Extrahiert **skalare** Werte (bis `NVARCHAR(4000)`); liefert `NULL` bei fehlendem Pfad (lax). |
| `JSON_QUERY` | Extrahiert **Objekt/Array** als JSON-Fragment (`NVARCHAR(MAX)`). |
| `JSON_MODIFY` | Aktualisiert/f√ºgt JSON-Pfade inline (R√ºckgabe ist ge√§nderter JSON-Text). |
| `OPENJSON` | **Shreddern** von JSON zu Zeilen/Spalten; ohne `WITH` (Key/Value/Type) oder mit `WITH` (stark typisiert, schneller). *(Erfordert Kompat.-Level ‚â• 130).* |
| JSON Path | `$` als Wurzel, `$.a.b[0]`; **lax** (Standard) ‚Üí `NULL` bei fehlendem Pfad; **strict** (`strict $.a`) ‚Üí Fehler bei fehlendem Pfad. |
| `FOR JSON` | Generiert JSON aus Resultsets (`AUTO`/`PATH`, `WITHOUT_ARRAY_WRAPPER`, `INCLUDE_NULL_VALUES`, `ROOT`). |
| Line-Delimited JSON | Eine JSON-Zeile pro Datensatz (JSONL); oft via `OPENROWSET(BULK ‚Ä¶ SINGLE_CLOB)` + Split verarbeitet. |
| Validierung | Formale (`ISJSON`) + fachliche Validierung (Pflichtfelder/Datentypen via `OPENJSON WITH` + `TRY_CONVERT`). |
| Fehlertoleranz | **LAX-Pfade**, `TRY_CAST/TRY_CONVERT`, Quarant√§ne-Tabellen, `TRY‚Ä¶CATCH` & Z√§hlwerte im **Run-Log**. |
| Indizierung | **Persistierte** berechnete Spalten aus `JSON_VALUE(...)` + **Indizes** (auch **Filtered** auf `ISJSON=1`). |
| Gr√∂√üen/Encoding | JSON ist Unicode (`NVARCHAR`) ‚Äì Dateilast i. d. R. UTF-8; beim Import passende **CODEPAGE** w√§hlen. |
| ETL-Formate | Arrays/Nesting via `CROSS APPLY OPENJSON(@json, '$.items')`; Rekursion durch weitere `OPENJSON` auf Unterobjekten. |

---

## 2 | Struktur

### 2.1 | Grundlagen & Funktionen (ISJSON, JSON_VALUE/QUERY/MODIFY, OPENJSON)
> **Kurzbeschreibung:** √úberblick √ºber JSON-Stack in T-SQL, Einsatzfelder im ETL und typische Stolperfallen.

- üìì **Notebook:**  
  [`08_01_json_grundlagen_overview.ipynb`](08_01_json_grundlagen_overview.ipynb)
- üé• **YouTube:**  
  - [JSON in SQL Server ‚Äì Basics](https://www.youtube.com/results?search_query=sql+server+json+basics)
- üìò **Docs:**  
  - [JSON-Daten in SQL Server](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-data-sql-server)

---

### 2.2 | Import: Dateien/Streams laden (OPENROWSET BULK, UTF-8, JSONL)
> **Kurzbeschreibung:** JSON-Dateien per `OPENROWSET(BULK)`/`BULK INSERT` laden; *SINGLE_CLOB*/*SINGLE_NCLOB*, Codepages, gro√üe Dateien.

- üìì **Notebook:**  
  [`08_02_import_openrowset_bulk_json.ipynb`](08_02_import_openrowset_bulk_json.ipynb)
- üé• **YouTube:**  
  - [Load JSON Files with OPENROWSET](https://www.youtube.com/results?search_query=sql+server+openrowset+json)
- üìò **Docs:**  
  - [`OPENROWSET(BULK)`](https://learn.microsoft.com/en-us/sql/t-sql/functions/openrowset-transact-sql) „Éª [`BULK INSERT`](https://learn.microsoft.com/en-us/sql/t-sql/statements/bulk-insert-transact-sql)

---

### 2.3 | Shreddern mit `OPENJSON` ‚Äì Key/Value vs. `WITH`-Schema
> **Kurzbeschreibung:** Unterschied ‚Äûungeschematisiert‚Äú (Key/Value/Type) vs. **typisiertes** `WITH` (schneller, sicherer).

- üìì **Notebook:**  
  [`08_03_openjson_with_schema.ipynb`](08_03_openjson_with_schema.ipynb)
- üé• **YouTube:**  
  - [OPENJSON WITH Explained](https://www.youtube.com/results?search_query=sql+server+openjson+with)
- üìò **Docs:**  
  - [`OPENJSON` ‚Äì Referenz & Beispiele](https://learn.microsoft.com/en-us/sql/relational-databases/json/openjson-transact-sql)

---

### 2.4 | Arrays & Nested Objects (CROSS APPLY, `AS JSON`)
> **Kurzbeschreibung:** Arrays √ºber `CROSS APPLY OPENJSON('$..')` iterieren; Unterobjekte mit `AS JSON` weiter verarbeiten.

- üìì **Notebook:**  
  [`08_04_arrays_nested_crossapply.ipynb`](08_04_arrays_nested_crossapply.ipynb)
- üé• **YouTube:**  
  - [Parse Nested JSON Arrays](https://www.youtube.com/results?search_query=sql+server+parse+nested+json)
- üìò **Docs:**  
  - [`OPENJSON ‚Ä¶ WITH (col type '$.path' **AS JSON**)`](https://learn.microsoft.com/en-us/sql/relational-databases/json/openjson-transact-sql#examples)

---

### 2.5 | Validierung: **Formale** + **Fachliche** Checks
> **Kurzbeschreibung:** `ISJSON` + Pflichtpfade (**strict**), Datentyppr√ºfungen (`TRY_CONVERT`), Regelverletzungen in **Reject**-Tabellen.

- üìì **Notebook:**  
  [`08_05_validation_isjson_strict_rules.ipynb`](08_05_validation_isjson_strict_rules.ipynb)
- üé• **YouTube:**  
  - [Validate JSON in ETL](https://www.youtube.com/results?search_query=sql+server+validate+json)
- üìò **Docs:**  
  - [`ISJSON`](https://learn.microsoft.com/en-us/sql/t-sql/functions/isjson-transact-sql) „Éª [JSON-Pfade (lax/strict)](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-path-expressions-sql-server)

---

### 2.6 | Fehlertoleranz: LAX-Pfade, TRY_CONVERT, Quarant√§ne
> **Kurzbeschreibung:** Robuste Pipelines mit `TRY‚Ä¶CATCH`, `TRY_CAST/TRY_CONVERT`, Z√§hlwerten & **Run-Log**.

- üìì **Notebook:**  
  [`08_06_fault_tolerance_try_convert_quarantine.ipynb`](08_06_fault_tolerance_try_convert_quarantine.ipynb)
- üé• **YouTube:**  
  - [Error Handling for JSON ETL](https://www.youtube.com/results?search_query=sql+server+json+error+handling)
- üìò **Docs:**  
  - [`TRY_CONVERT`](https://learn.microsoft.com/en-us/sql/t-sql/functions/try-convert-transact-sql) „Éª [`TRY‚Ä¶CATCH`](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/try-catch-transact-sql)

---

### 2.7 | Idempotenz & Wasserzeichen mit JSON-Quellen
> **Kurzbeschreibung:** High-Water-Mark (z. B. `LastModified`/`rowversion`) + Hashdiff aus JSON-Feldern; Upsert-Muster.

- üìì **Notebook:**  
  [`08_07_idempotenz_wasserzeichen_json.ipynb`](08_07_idempotenz_wasserzeichen_json.ipynb)
- üé• **YouTube:**  
  - [Incremental Loads from JSON](https://www.youtube.com/results?search_query=incremental+load+json+sql+server)
- üìò **Docs:**  
  - [`HASHBYTES` (SHA2_256)](https://learn.microsoft.com/en-us/sql/t-sql/functions/hashbytes-transact-sql)

---

### 2.8 | Aufbereitung & Normalisierung (Staging ‚Üí Core)
> **Kurzbeschreibung:** JSON shapen, Normalformen bef√ºllen (Parent/Child), Schl√ºsselzuordnung, referentielle Checks.

- üìì **Notebook:**  
  [`08_08_normalisierung_parent_child.ipynb`](08_08_normalisierung_parent_child.ipynb)
- üé• **YouTube:**  
  - [Normalize JSON to Relational](https://www.youtube.com/results?search_query=normalize+json+to+sql+server)
- üìò **Docs:**  
  - [Beispiele f√ºr `OPENJSON` ‚Üí Relationen](https://learn.microsoft.com/en-us/sql/relational-databases/json/convert-json-data-to-rows-and-columns-with-openjson)

---

### 2.9 | Indizes & SARGability: **Computed Columns** aus JSON
> **Kurzbeschreibung:** Persistierte Spalten auf `JSON_VALUE(...)` + **(Filtered) Index**; Performance/Plan-Stabilit√§t.

- üìì **Notebook:**  
  [`08_09_computed_columns_json_indexing.ipynb`](08_09_computed_columns_json_indexing.ipynb)
- üé• **YouTube:**  
  - [Index JSON Fields via Computed Columns](https://www.youtube.com/results?search_query=sql+server+json+index+computed+column)
- üìò **Docs:**  
  - [Indexing JSON data](https://learn.microsoft.com/en-us/sql/relational-databases/json/index-json-data)

---

### 2.10 | `FOR JSON` ‚Äì saubere JSON-Ausgabe f√ºr APIs
> **Kurzbeschreibung:** `AUTO` vs. `PATH`, `WITHOUT_ARRAY_WRAPPER`, `INCLUDE_NULL_VALUES`, Steuerung von Feldnamen/Struktur.

- üìì **Notebook:**  
  [`08_10_for_json_output_patterns.ipynb`](08_10_for_json_output_patterns.ipynb)
- üé• **YouTube:**  
  - [FOR JSON PATH Deep Dive](https://www.youtube.com/results?search_query=sql+server+for+json+path)
- üìò **Docs:**  
  - [`FOR JSON` ‚Äì Referenz](https://learn.microsoft.com/en-us/sql/relational-databases/json/format-query-results-as-json-with-for-json-sql-server)

---

### 2.11 | Updates im JSON (`JSON_MODIFY`) & Patch-Strategien
> **Kurzbeschreibung:** Felder setzen/entfernen/array-append; Vorsicht bei gro√üen JSONs (Neuschreiben des Strings).

- üìì **Notebook:**  
  [`08_11_json_modify_patch_patterns.ipynb`](08_11_json_modify_patch_patterns.ipynb)
- üé• **YouTube:**  
  - [JSON_MODIFY Examples](https://www.youtube.com/results?search_query=json_modify+sql+server)
- üìò **Docs:**  
  - [`JSON_MODIFY`](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-modify-transact-sql)

---

### 2.12 | Qualit√§tssicherung: Constraints, Schemas & Tests
> **Kurzbeschreibung:** `CHECK (ISJSON(...)=1)`, Pflichtfelder via **strict**-Pfade testen, Testdaten/Golden Files.

- üìì **Notebook:**  
  [`08_12_quality_checks_constraints_schema.ipynb`](08_12_quality_checks_constraints_schema.ipynb)
- üé• **YouTube:**  
  - [JSON Constraints & Testing](https://www.youtube.com/results?search_query=sql+server+json+constraints)
- üìò **Docs:**  
  - [JSON-Validierung mit Pfaden](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-path-expressions-sql-server)

---

### 2.13 | Gro√üe Datenmengen: Batching, Minimal Logging, Parallelisierung
> **Kurzbeschreibung:** *Landing* in Heap/`#temp`, Batch-Loops (`TOP (N)`), minimal geloggte Loads, Partitionierung.

- üìì **Notebook:**  
  [`08_13_large_scale_batched_json_etl.ipynb`](08_13_large_scale_batched_json_etl.ipynb)
- üé• **YouTube:**  
  - [Batch Process JSON at Scale](https://www.youtube.com/results?search_query=batch+process+json+sql+server)
- üìò **Docs:**  
  - [Performancehinweise JSON](https://learn.microsoft.com/en-us/sql/relational-databases/json/optimize-json-processing-with-in-memory-oltp) *(allg. Hinweise)*

---

### 2.14 | Sicherheit & Governance (Least Privilege, Secrets)
> **Kurzbeschreibung:** Trennung `landing/stg/core`, Rollen f√ºr JSON-Tabellen, Module-Signing, Secrets (z. B. Pfade) nicht hardcoden.

- üìì **Notebook:**  
  [`08_14_security_governance_json_etl.ipynb`](08_14_security_governance_json_etl.ipynb)
- üé• **YouTube:**  
  - [Secure JSON Pipelines](https://www.youtube.com/results?search_query=secure+json+etl+sql+server)
- üìò **Docs:**  
  - [Permissions & Securables ‚Äì √úberblick](https://learn.microsoft.com/en-us/sql/relational-databases/security/permissions-database-engine)

---

### 2.15 | Monitoring & Betrieb (Z√§hlwerte, Run-Log, Alerts)
> **Kurzbeschreibung:** L√§ufe protokollieren (gelesen/valid/invalid/geschrieben), Alerting via SQL Agent/DB Mail, Trendberichte.

- üìì **Notebook:**  
  [`08_15_monitoring_runlog_alerts.ipynb`](08_15_monitoring_runlog_alerts.ipynb)
- üé• **YouTube:**  
  - [ETL Run Logging Patterns](https://www.youtube.com/results?search_query=etl+run+logging+sql+server)
- üìò **Docs:**  
  - [SQL Server Agent ‚Äì Benachrichtigungen](https://learn.microsoft.com/en-us/sql/ssms/agent/alerts)

---

### 2.16 | Anti-Patterns & Checkliste
> **Kurzbeschreibung:** `LIKE` zum Parsen, `JSON_VALUE` f√ºr gro√üe Fragmente statt `JSON_QUERY`, fehlende `ISJSON`-Checks, nicht persistierte berechnete Spalten, blindes `MERGE`, fehlende Fehlertoleranz/Quarant√§ne, `NVARCHAR(4000)`-Truncation.

- üìì **Notebook:**  
  [`08_16_antipatterns_checkliste_json_etl.ipynb`](08_16_antipatterns_checkliste_json_etl.ipynb)
- üé• **YouTube:**  
  - [Common JSON ETL Mistakes](https://www.youtube.com/results?search_query=common+json+mistakes+sql+server)
- üìò **Docs/Blog:**  
  - [Best Practices ‚Äì JSON in SQL Server](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-data-sql-server#best-practices)

---

## 3 | Weiterf√ºhrende Informationen

- üìò Microsoft Learn: [JSON ‚Äì √úberblick & Beispiele](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-data-sql-server)  
- üìò Microsoft Learn: [`OPENJSON` ‚Äì Referenz](https://learn.microsoft.com/en-us/sql/relational-databases/json/openjson-transact-sql)  
- üìò Microsoft Learn: [`JSON_VALUE` / `JSON_QUERY` / `JSON_MODIFY`](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-functions-transact-sql)  
- üìò Microsoft Learn: [`FOR JSON` ‚Äì Ausgabe formatieren](https://learn.microsoft.com/en-us/sql/relational-databases/json/format-query-results-as-json-with-for-json-sql-server)  
- üìò Microsoft Learn: [JSON-Pfad-Ausdr√ºcke (lax/strict)](https://learn.microsoft.com/en-us/sql/relational-databases/json/json-path-expressions-sql-server)  
- üìò Microsoft Learn: [JSON indizieren (Computed Columns)](https://learn.microsoft.com/en-us/sql/relational-databases/json/index-json-data)  
- üìò Microsoft Learn: [`OPENROWSET(BULK)` ‚Äì Files laden](https://learn.microsoft.com/en-us/sql/t-sql/functions/openrowset-transact-sql)  
- üìò Microsoft Learn: [`TRY_CONVERT` / `TRY_CAST`](https://learn.microsoft.com/en-us/sql/t-sql/functions/try-convert-transact-sql)  
- üìù Simple Talk (Redgate): *Working with JSON in SQL Server*  
- üìù SQLPerformance: *Indexing & Tuning JSON Workloads* ‚Äì https://www.sqlperformance.com/?s=json  
- üìù Erik Darling: *Computed Columns on JSON_VALUE ‚Äì Pros & Cons* ‚Äì https://www.erikdarlingdata.com/  
- üìù Brent Ozar: *Stop Shredding JSON the Slow Way* ‚Äì https://www.brentozar.com/  
- üìù Itzik Ben-Gan (Blog/Artikel): *OPENJSON Patterns & Strict Paths*  
- üé• YouTube (Data Exposed): *JSON in SQL Server ‚Äì Deep Dive* ‚Äì Suchlink  
- üé• YouTube: *OPENJSON WITH + Arrays ‚Äì Demo* ‚Äì Suchlink  
